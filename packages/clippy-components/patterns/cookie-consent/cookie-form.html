<clippy-cookie-form>
  <style>
    .clippy-cookie-form .utrecht-form-fieldset {
      margin-block-end: var(--basis-space-block-xl, 2rem);
    }

    .clippy-cookie-form .utrecht-form-fieldset__legend > h3 {
      margin-block-end: var(--basis-space-block-md, 0.5rem);
    }

    .clippy-cookie-form .utrecht-form-fieldset__legend > p:first-of-type {
      margin-block-end: var(--basis-space-block-lg, 1rem);
    }

    .clippy-cookie-form .utrecht-form-field__label {
      margin-block-end: var(--basis-space-block-md, 0.5rem);
    }

    .clippy-cookie-form .utrecht-form-field__label:last-of-type {
      margin-block-end: var(--basis-space-block-xl, 2rem);
    }

    .clippy-cookie-form__button-group {
      margin-block-start: var(--basis-space-block-xl, 2rem);
    }

    .clippy-cookie-form__success {
      margin-block-start: var(--basis-space-block-xl, 2rem);
    }

    .clippy-cookie-form__success[hidden] {
      display: none;
    }
  </style>

  <form class="clippy-cookie-form">
    <div class="utrecht-form-fieldset">
      <fieldset class="utrecht-form-fieldset__fieldset utrecht-form-fieldset--html-fieldset">
        <legend class="utrecht-form-fieldset__legend utrecht-form-fieldset__legend--html-legend">
          <h3 class="utrecht-heading-3">Cookies die het gebruik van de omgeving meten</h3>
          <p class="utrecht-paragraph">
            Deze cookies helpen ons te begrijpen hoe mensen deze omgeving gebruiken, zodat we deze kunnen verbeteren. Zo
            meten we bijvoorbeeld welke pagina's worden bezocht en hoelang bezoekers op een pagina blijven.
          </p>
        </legend>

        <div class="utrecht-form-field__label utrecht-form-field__label--radio">
          <label class="utrecht-form-label utrecht-form-label--radio">
            <input
              type="radio"
              name="analytics"
              class="utrecht-radio-button utrecht-radio-button--html-input utrecht-radio-button--custom utrecht-form-field__input"
              value="on"
            />
            Cookies gebruiken die het gebruik van de omgeving meten
          </label>
        </div>

        <div class="utrecht-form-field__label utrecht-form-field__label--radio">
          <label class="utrecht-form-label utrecht-form-label--radio">
            <input
              type="radio"
              name="analytics"
              class="utrecht-radio-button utrecht-radio-button--html-input utrecht-radio-button--custom utrecht-form-field__input"
              value="off"
              checked
            />
            Geen cookies gebruiken die het gebruik van de omgeving meten
          </label>
        </div>
      </fieldset>
    </div>

    <div class="utrecht-form-fieldset">
      <fieldset class="utrecht-form-fieldset__fieldset utrecht-form-fieldset--html-fieldset">
        <legend class="utrecht-form-fieldset__legend utrecht-form-fieldset__legend--html-legend">
          <h3 class="utrecht-heading-3">Cookies die je instellingen onthouden</h3>
          <p class="utrecht-paragraph">
            Deze cookies onthouden je voorkeuren en de keuzes die je maakt, zodat we je ervaring kunnen personaliseren.
          </p>
        </legend>

        <div class="utrecht-form-field__label utrecht-form-field__label--radio">
          <label class="utrecht-form-label utrecht-form-label--radio">
            <input
              type="radio"
              name="preferences"
              class="utrecht-radio-button utrecht-radio-button--html-input utrecht-radio-button--custom utrecht-form-field__input"
              value="on"
            />
            Cookies gebruiken die mijn instellingen onthouden
          </label>
        </div>

        <div class="utrecht-form-field__label utrecht-form-field__label--radio">
          <label class="utrecht-form-label utrecht-form-label--radio">
            <input
              type="radio"
              name="preferences"
              class="utrecht-radio-button utrecht-radio-button--html-input utrecht-radio-button--custom utrecht-form-field__input"
              value="off"
              checked
            />
            Geen cookies gebruiken die mijn instellingen onthouden
          </label>
        </div>
      </fieldset>
    </div>

    <div class="utrecht-form-fieldset">
      <fieldset class="utrecht-form-fieldset__fieldset utrecht-form-fieldset--html-fieldset">
        <legend class="utrecht-form-fieldset__legend utrecht-form-fieldset__legend--html-legend">
          <h3 class="utrecht-heading-3">Strikt noodzakelijke cookies</h3>
          <p class="utrecht-paragraph">
            Deze essentiÃ«le cookies zijn nodig om deze omgeving te laten werken. Ze onthouden bijvoorbeeld je voortgang
            in een meerstapsformulier.
          </p>
          <p class="utrecht-paragraph">Omdat ze essentieel zijn, staan deze cookies altijd aan.</p>
        </legend>
      </fieldset>
    </div>

    <div class="utrecht-button-group clippy-cookie-form__button-group">
      <button type="submit" class="utrecht-button utrecht-button--primary-action">Instellingen opslaan</button>
    </div>

    <div class="utrecht-alert utrecht-alert--success clippy-cookie-form__success" role="alert" hidden>
      <p class="utrecht-paragraph">Je cookie-instellingen zijn opgeslagen.</p>
    </div>
  </form>
</clippy-cookie-form>

<script type="module">
  const STORAGE_KEY = 'cookie-consent-preferences';

  class ClippyCookieForm extends HTMLElement {
    connectedCallback() {
      const form = this.querySelector('form');
      if (!form) return;

      // Load saved preferences
      this.loadPreferences(form);

      // Handle form submission
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        this.savePreferences(form);
      });
    }

    loadPreferences(form) {
      try {
        const saved = globalThis.localStorage?.getItem(STORAGE_KEY);
        if (!saved) return;

        const { preferences = [] } = JSON.parse(saved);

        this.setRadioValue(form, 'analytics', preferences.includes('analytics'));
        this.setRadioValue(form, 'preferences', preferences.includes('preferences'));
      } catch {
        // localStorage not available
      }
    }

    setRadioValue(form, name, isOn) {
      const inputs = form.querySelectorAll(`input[name="${name}"]`);
      inputs.forEach((input) => {
        input.checked = input.value === (isOn ? 'on' : 'off');
      });
    }

    savePreferences(form) {
      const formData = new FormData(form);
      const preferences = [];

      if (formData.get('analytics') === 'on') preferences.push('analytics');
      if (formData.get('preferences') === 'on') preferences.push('preferences');

      try {
        globalThis.localStorage?.setItem(
          STORAGE_KEY,
          JSON.stringify({
            preferences,
            timestamp: new Date().toISOString(),
          }),
        );
      } catch {
        // localStorage not available
      }

      // Dispatch custom event for parent components to handle
      this.dispatchEvent(
        new CustomEvent('cookie-preferences-saved', {
          bubbles: true,
          detail: { preferences },
        }),
      );

      // Show success message
      const successMessage = form.querySelector('.clippy-cookie-form__success');
      if (successMessage) {
        successMessage.removeAttribute('hidden');
        successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
  }

  if (typeof globalThis !== 'undefined' && 'customElements' in globalThis) {
    const tagName = 'clippy-cookie-form';
    if (!customElements.get(tagName)) {
      customElements.define(tagName, ClippyCookieForm);
    }
  }
</script>
