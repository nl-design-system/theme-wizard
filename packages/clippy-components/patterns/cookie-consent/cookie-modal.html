<clippy-cookie-consent-modal hidden>
  <style>
    .clippy-cookie-consent-modal__dialog {
      max-height: 90vh;
      max-width: 40rem;
      overflow-y: auto;
    }

    .clippy-cookie-consent-modal__dialog > h2 {
      margin-block-end: var(--basis-space-block-lg);
    }

    .clippy-cookie-consent-modal__intro {
      margin-block-end: var(--basis-space-block-xl);
    }

    .clippy-cookie-consent-modal__intro > p {
      margin-block-end: var(--basis-space-block-md);
    }

    .clippy-cookie-consent-modal__intro > p:last-child {
      margin-block-end: 0;
    }

    .clippy-cookie-consent-modal__button-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--basis-space-column-md);
      align-items: center;
      margin-block-start: var(--basis-space-block-xl);
    }

    .clippy-cookie-consent-modal__simple-view[hidden],
    .clippy-cookie-consent-modal__detailed-view[hidden] {
      display: none;
    }
  </style>

  <dialog class="clippy-cookie-consent-modal__dialog" aria-labelledby="cookie-consent-modal-title">
    <div class="clippy-cookie-consent-modal__simple-view">
      <h2 id="cookie-consent-modal-title" class="utrecht-heading-2">Cookies op deze website</h2>

      <div class="clippy-cookie-consent-modal__intro">
        <p class="utrecht-paragraph">We gebruiken enkele essentiële cookies om deze website goed te laten werken.</p>
        <p class="utrecht-paragraph">
          We willen graag aanvullende cookies plaatsen om te begrijpen hoe je deze website gebruikt, je instellingen te
          onthouden en onze diensten te verbeteren.
        </p>
        <p class="utrecht-paragraph">
          We gebruiken ook cookies die door andere sites zijn geplaatst om ons te helpen content van hun diensten te
          leveren.
        </p>
      </div>

      <form method="dialog" class="clippy-cookie-consent-modal__form">
        <div class="clippy-cookie-consent-modal__button-group">
          <button class="utrecht-button utrecht-button--primary-action" value="accept" autofocus>Accepteren</button>
          <button class="utrecht-button utrecht-button--secondary-action" value="reject">Weigeren</button>
          <button type="button" class="utrecht-button clippy-cookie-consent-modal__settings-link">
            Zelf instellen
          </button>
        </div>
      </form>
    </div>

    <div class="clippy-cookie-consent-modal__detailed-view" hidden>
      <h2 class="utrecht-heading-2">Cookie-instellingen</h2>

      <div class="clippy-cookie-consent-modal__intro">
        <p class="utrecht-paragraph">
          Je kunt zelf kiezen welke soorten optionele cookies je toestaat. We gebruiken een cookie om je instellingen op
          te slaan.
        </p>
      </div>

      <clippy-cookie-form></clippy-cookie-form>

      <div class="clippy-cookie-consent-modal__button-group">
        <button
          type="button"
          class="utrecht-button utrecht-button--secondary-action clippy-cookie-consent-modal__back-button"
        >
          Terug
        </button>
      </div>
    </div>
  </dialog>
</clippy-cookie-consent-modal>

<script type="module">
  const STORAGE_KEY = 'cookie-consent-preferences';

  class ClippyCookieConsentModal extends HTMLElement {
    static get observedAttributes() {
      return ['organization'];
    }

    connectedCallback() {
      // Only show the modal if JavaScript is enabled
      this.removeAttribute('hidden');

      const dialog = this.querySelector('dialog');
      if (!dialog) return;

      // Handle organization attribute for identifying the sender
      const organization = this.getAttribute('organization');
      if (organization) {
        const title = dialog.querySelector('h2');
        if (title) {
          title.textContent = `Cookies op de website van ${organization}`;
        }
        const introParagraphs = dialog.querySelectorAll('.clippy-cookie-consent-modal__intro p');
        if (introParagraphs.length > 0) {
          const firstParagraph = introParagraphs[0];
          firstParagraph.textContent = `${organization} gebruikt enkele essentiële cookies om deze website goed te laten werken.`;
        }
      }

      const form = dialog.querySelector('form');
      if (!form) return;

      // Check if the user has already made a choice
      try {
        const saved = globalThis.localStorage?.getItem(STORAGE_KEY);
        if (saved) {
          this.hidden = true;
          return;
        }
      } catch {}

      // Always show as modal (blocking with focus trap)
      dialog.showModal();

      // Implement focus trap: cycle through focusable elements
      const focusableElements = dialog.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      const trapFocus = (e) => {
        if (e.key !== 'Tab') return;

        if (e.shiftKey) {
          // Shift + Tab: moving backwards
          if (document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          }
        } else if (document.activeElement === lastFocusable) {
          // Tab: moving forwards
          e.preventDefault();
          firstFocusable.focus();
        }
      };

      dialog.addEventListener('keydown', trapFocus);

      // Clean up event listener when dialog closes
      const originalClose = () => {
        dialog.removeEventListener('keydown', trapFocus);
      };

      dialog.addEventListener('close', originalClose, { once: true });

      // Handle view switching
      const simpleView = dialog.querySelector('.clippy-cookie-consent-modal__simple-view');
      const detailedView = dialog.querySelector('.clippy-cookie-consent-modal__detailed-view');
      const settingsLink = dialog.querySelector('.clippy-cookie-consent-modal__settings-link');
      const backButton = dialog.querySelector('.clippy-cookie-consent-modal__back-button');

      if (settingsLink) {
        settingsLink.addEventListener('click', (e) => {
          e.preventDefault();
          simpleView?.setAttribute('hidden', '');
          detailedView?.removeAttribute('hidden');
        });
      }

      if (backButton) {
        backButton.addEventListener('click', () => {
          detailedView?.setAttribute('hidden', '');
          simpleView?.removeAttribute('hidden');
        });
      }

      // Listen to cookie form save event
      const cookieForm = dialog.querySelector('clippy-cookie-form');
      if (cookieForm) {
        cookieForm.addEventListener('cookie-preferences-saved', () => {
          this.hidden = true;
          dialog.close();
        });
      }

      dialog.addEventListener('close', () => {
        const action = dialog.returnValue;
        if (!action) {
          // Closed via Esc: no choice saved
          this.hidden = true;
          return;
        }

        // Save preferences to localStorage
        const preferences = action === 'accept' ? ['analytics', 'preferences'] : [];
        try {
          globalThis.localStorage?.setItem(
            STORAGE_KEY,
            JSON.stringify({
              preferences,
              timestamp: new Date().toISOString(),
            }),
          );
        } catch {}

        this.hidden = true;
      });
    }
  }

  if (typeof globalThis !== 'undefined' && 'customElements' in globalThis) {
    const tagName = 'clippy-cookie-consent-modal';
    if (!customElements.get(tagName)) {
      customElements.define(tagName, ClippyCookieConsentModal);
    }
  }
</script>
