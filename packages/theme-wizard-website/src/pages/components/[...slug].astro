---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { components } from '@/lib/components'
import { Traverse } from 'neotraverse/modern'
import dlv from 'dlv'
import { getStories } from '../../../../theme-wizard-app/src/utils/csf-utils'

type StoryObject = {
  name?: string;
  parameters?: {
    editableTokens?: unknown;
    [key: PropertyKey]: unknown;
  };
  [key: PropertyKey]: unknown;
};

export function getStaticPaths() {
  return Object.keys(components).map(slug => ({
    params: { slug }
  }))
}

const componentList = await Promise.all(Object.entries(components).map(async ([slug, module]) => {
  const componentModule = await module()
  return {
    slug,
    title: componentModule.default.title
  }
}))

const slug = Astro.params.slug as keyof typeof components
const nlDesignSystemDocsUrl = new URL('https://nldesignsystem.nl')
nlDesignSystemDocsUrl.pathname = slug
const componentModulePromiseFn = components[slug]
const componentModule = await componentModulePromiseFn()
const { default: meta, ...storyExports } = componentModule
const stories = getStories(storyExports as unknown as Record<PropertyKey, StoryObject>, meta)
const storyIds = stories.map(([id]) => id)

function getTokenLeaves(tokenObj: any) {
  const leaves: {path: PropertyKey[], value: any}[] = [];
  new Traverse(tokenObj).forEach((ctx, node) => {
    if (ctx.isLeaf) {
      const pathWithoutValue = ctx.path.slice(0, -1)
      leaves.push({
        path: pathWithoutValue,
        value: node
      })
    }
  });
  return leaves;
}

const storiesWithTokens = stories.map(([id, story]) => {
  const storyTokens = (story as any).parameters?.editableTokens
  return ({
    id,
    story,
    tokens: storyTokens
      ? getTokenLeaves(storyTokens).map(leaf => {
        const token = dlv(componentModule.default.parameters?.tokens, leaf.path.join('.'))
        return {
          ...leaf,
          token
        }
      })
      : []
  })
})
---

<BaseLayout title="Theme Wizard">
  <theme-wizard-app>
    <wizard-layout>
      <!-- TODO: implement proper sidenav https://github.com/nl-design-system/theme-wizard/issues/532 -->
      <nav slot="sidebar">
        {componentList.map(({slug, title}) => (
          <wizard-sidebar-link href={`/components/${slug}`}>{title}</wizard-sidebar-link>
        ))}
      </nav>
      <main slot="main">
        <!-- TODO: make proper breadcrumb https://github.com/nl-design-system/theme-wizard/issues/531 -->
        <nav>
          <a href="/">Wizard</a> /
          <a href="/components">Componenten</a> /
          <span>{slug}</span>
        </nav>

        <h1>{slug}</h1>

        <p>
          Bekijk de component-documentatie <a href={nlDesignSystemDocsUrl.toString()} target="_blank">nldesignsystem.nl</a>.
        </p>

        <div id="story-container" data-story-ids={JSON.stringify(storyIds)} data-component-id={slug}></div>

        {storiesWithTokens.map(({id, story, tokens}) => (
          <section>
            <h2>{story.name}</h2>
            <wizard-story-preview>
              {/* theme-preview makes sure the CSS generated by theme-wizard config gets applied after reset */}
              <wizard-reset-theme>
                <wizard-preview-theme>
                  <div data-story-container={id}></div>
                </wizard-preview-theme>
              </wizard-reset-theme>
            </wizard-story-preview>
            {tokens.length > 0 && (
              <dl>
                {tokens.map((token) => (
                  <dt>{token.path.join('.')}</dt>
                  <dd>{token.token?.$type ?? 'unknown type'}</dd>
                  <dd>
                    <wizard-token-field path={token.path.join('.')}></wizard-token-field>
                  </dd>
                ))}
              </dl>
            )}
          </section>
        ))}
      </main>
     </wizard-layout>
  </theme-wizard-app>
</BaseLayout>

<script>
  import { initStories } from '@/components/render-stories';
  import type { components } from '@/lib/components';

  const container = document.getElementById('story-container');
  const storyIds = JSON.parse(container!.dataset.storyIds || '[]');
  // Assertion here is type-safe because that's taken care of by Astro in the top of this file
  const componentId = container?.dataset.componentId! as keyof typeof components

  initStories(componentId, storyIds);
</script>
