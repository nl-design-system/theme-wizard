---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { components } from '@/lib/components'
import { Traverse } from 'neotraverse/modern'
import dlv from 'dlv'
import { getStories } from '../../../../theme-wizard-app/src/utils/csf-utils'

export function getStaticPaths() {
  return Object.keys(components).map(slug => ({
    params: {slug}
  }))
}

const componentList = await Promise.all(Object.entries(components).map(async ([slug, module]) => {
  const componentModule = await module()
  const title = componentModule.default.title
  return {
    slug,
    title
  }
}))

const slug = Astro.params.slug

const componentModulePromiseFn = components[slug]
const componentModule = await componentModulePromiseFn()
const stories = getStories(componentModule, componentModule.default)
const storyIds = stories.map(([id]) => id)

function getTokenLeaves(tokenObj: any) {
  const leaves: {path: PropertyKey[], value: any}[] = [];
  new Traverse(tokenObj).forEach((ctx, node) => {
    if (ctx.isLeaf) {
      const pathWithoutValue = ctx.path.slice(0, -1)
      leaves.push({
        path: pathWithoutValue,
        value: node
      })
    }
  });
  return leaves;
}

const storiesWithTokens = stories.map(([id, story]) => {
  const storyTokens = story.parameters?.editableTokens
  return ({
    id,
    story,
    tokens: storyTokens
      ? getTokenLeaves(storyTokens).map(leaf => {
        const token = dlv(componentModule.default.parameters?.tokens, leaf.path.join('.'))
        return {
          ...leaf,
          token
        }
      })
      : []
  })
})
---

<BaseLayout title="Theme Wizard">
  <theme-wizard-app>
    <wizard-layout>
      <!-- TODO: implement proper sidenav -->
      <nav slot="sidebar">
        {componentList.map(({slug, title}) => (
          <a href={`/components/${slug}`}>{title}</a>
          <br />
        ))}
      </nav>
      <main slot="main">
        <!-- TODO: make proper breadcrumb -->
        <nav>
          <a href="/">Wizard</a> /
          <a href="/components">Componenten</a> /
          <span>{slug}</span>
        </nav>
        <h1>{slug}</h1>

        <div id="story-container" data-story-ids={JSON.stringify(storyIds)} data-component-id={slug}></div>

        {storiesWithTokens.map(({id, story, tokens}) => (
          <section>
            <h2>{story.name}</h2>
            <wizard-story-preview>
              {/* theme-preview makes sure the CSS generated by theme-wizard config gets applied */}
              <div data-story-container={id}></div>
            </wizard-story-preview>
            {tokens.length > 0 && (
              <dl>
                {tokens.map((token) => (
                  <dt>{token.path.join('.')}</dt>
                  <dd>{token.token?.$type ?? 'unknown type'}</dd>
                ))}
              </dl>
            )}
          </section>
        ))}
      </main>
     </wizard-layout>
  </theme-wizard-app>
</BaseLayout>

<script>
  import { initStories } from '@/components/render-stories';

  const container = document.getElementById('story-container');
  const storyIds = JSON.parse(container!.dataset.storyIds || '[]');
  const componentId = container?.dataset.componentId!

  initStories(componentId, storyIds);
</script>